<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>IMS - Data Entry</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        h2 { text-align: center; }
        select, input, button { display: block; margin: 10px 0; padding: 8px; width: 300px; }
        .form-container { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.2); max-width: 400px; margin: 0 auto; }
        .hidden { display: none; }
        .error { color: red; }
        .success { color: green; }
        a { display: inline-block; margin-top: 10px; text-decoration: none; color: #fff; background: #4CAF50; padding: 8px 12px; border-radius: 4px; }
        a:hover { background: #45a049; }
    </style>
</head>
<body>

<h2>IMS - Data Entry</h2>

<div class="form-container">
    <!-- Action type selection -->
    <label for="actionType">Select action type:</label>
    <select id="actionType">
        <option value="">-- Select --</option>
        <option value="purchase">Purchase</option>
        <option value="servicing">Servicing</option>
        <option value="rental">Rental</option>
        <option value="disposal">Disposal</option>
    </select>

    <!-- Purchase form -->
    <form id="purchaseForm" class="hidden">
        <h3>Purchase</h3>
        <input type="text" id="purchaseItem" placeholder="Item" maxlength="24">
        <input type="text" id="supplier" placeholder="Supplier" maxlength="24">
        <input type="date" id="purchaseDate">
        <input type="number" step="0.01" id="amount" placeholder="Amount">
        <input type="text" id="currency" placeholder="Currency" maxlength="3">
        <input type="text" id="invoice" placeholder="Invoice" maxlength="12">
        <input type="text" id="notes" placeholder="Notes" maxlength="24">
        <button type="button" onclick="submitPurchase()">Submit Purchase</button>
        <div class="error" id="purchaseError"></div>
        <div class="success" id="purchaseSuccess"></div>
    </form>

    <!-- Servicing form -->
    <form id="servicingForm" class="hidden">
        <h3>Servicing</h3>
        <input type="text" id="servicingItem" placeholder="Item" maxlength="24">
        <input type="text" id="supplierServ" placeholder="Supplier" maxlength="24">
        <input type="date" id="servicingDate">
        <input type="number" step="0.01" id="amountServ" placeholder="Amount">
        <input type="text" id="currencyServ" placeholder="Currency" maxlength="3">
        <input type="text" id="invoiceServ" placeholder="Invoice" maxlength="12">
        <input type="text" id="notesServ" placeholder="Notes" maxlength="24">
        <button type="button" onclick="submitServicing()">Submit Servicing</button>
        <div class="error" id="servicingError"></div>
        <div class="success" id="servicingSuccess"></div>
    </form>

    <!-- Rental form -->
    <form id="rentalForm" class="hidden">
        <h3>Rental</h3>
        <input type="text" id="rentalItem" placeholder="Item" maxlength="24">
        <input type="date" id="rentalDate">
        <input type="text" id="renterName" placeholder="Renter Name" maxlength="24">
        <select id="rentalType">
            <option value="loan">Loaned</option>
            <option value="return">Returned</option>
        </select>
        <input type="text" id="notesRental" placeholder="Notes" maxlength="24">
        <button type="button" onclick="submitRental()">Submit Rental</button>
        <div class="error" id="rentalError"></div>
        <div class="success" id="rentalSuccess"></div>
    </form>

    <!-- Disposal form -->
    <form id="disposalForm" class="hidden">
        <h3>Disposal</h3>
        <input type="text" id="disposalItem" placeholder="Item" maxlength="24">
        <input type="date" id="disposalDate">
        <select id="disposalReason">
            <option value="disposal">Disposal</option>
            <option value="damage">Damage</option>
            <option value="loss">Loss</option>
            <option value="theft">Theft</option>
            <option value="sale">Sale</option>
            <option value="other">Other</option>
        </select>
        <input type="text" id="notesDisposal" placeholder="Notes" maxlength="24">
        <button type="button" onclick="submitDisposal()">Submit Disposal</button>
        <div class="error" id="disposalError"></div>
        <div class="success" id="disposalSuccess"></div>
    </form>

    <a href="/frontend/menu/" id="backToMenu">Zpět do menu</a>
</div>

<script>
    // Přihlášení
    const accessToken = sessionStorage.getItem('access_token');
    const role = sessionStorage.getItem('role');

    if (!accessToken || !role) {
        alert('Nejsi přihlášen. Přesměrování na login.');
        window.location.href = '/login/';
    }

    // Map forms
    const forms = {
        purchase: document.getElementById('purchaseForm'),
        servicing: document.getElementById('servicingForm'),
        rental: document.getElementById('rentalForm'),
        disposal: document.getElementById('disposalForm')
    };

    const actionType = document.getElementById('actionType');
    actionType.addEventListener('change', () => {
        Object.values(forms).forEach(f => f.classList.add('hidden'));
        const selected = actionType.value;
        if (forms[selected]) forms[selected].classList.remove('hidden');
    });

    async function submitData(url, payload, type) {
        const errorDiv = document.getElementById(type + 'Error');
        const successDiv = document.getElementById(type + 'Success');
        errorDiv.textContent = '';
        successDiv.textContent = '';

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${accessToken}`
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) throw new Error('Chyba při odesílání dat.');
            successDiv.textContent = 'Data byla úspěšně uložena!';
            forms[type].reset();

        } catch (err) {
            errorDiv.textContent = err.message;
        }
    }

    // Submit functions
    async function submitPurchase() { await submitData('/api/purchases/', {
        item: document.getElementById('purchaseItem').value,
        supplier: document.getElementById('supplier').value,
        purchase_date: document.getElementById('purchaseDate').value,
        amount: parseFloat(document.getElementById('amount').value),
        currency: document.getElementById('currency').value,
        invoice: document.getElementById('invoice').value,
        notes: document.getElementById('notes').value
    }, 'purchase'); }

    async function submitServicing() { await submitData('/api/servicings/', {
        inventory_item: document.getElementById('servicingItem').value,
        supplier: document.getElementById('supplierServ').value,
        service_date: document.getElementById('servicingDate').value,
        amount: parseFloat(document.getElementById('amountServ').value),
        currency: document.getElementById('currencyServ').value,
        invoice: document.getElementById('invoiceServ').value,
        notes: document.getElementById('notesServ').value
    }, 'servicing'); }

    async function submitRental() { await submitData('/api/rentals/', {
        inventory_item: document.getElementById('rentalItem').value,
        action_date: document.getElementById('rentalDate').value,
        renter_name: document.getElementById('renterName').value,
        rental_type: document.getElementById('rentalType').value,
        notes: document.getElementById('notesRental').value
    }, 'rental'); }

    async function submitDisposal() { await submitData('/api/disposals/', {
        inventory_item: document.getElementById('disposalItem').value,
        disposal_date: document.getElementById('disposalDate').value,
        disposal_reason: document.getElementById('disposalReason').value,
        notes: document.getElementById('notesDisposal').value
    }, 'disposal'); }

</script>

</body>
</html>